import polars as pl
import structlog
from polars import col

from biolit import DATADIR

TAXREF_HIERARCHY = ["regne", "phylum", "classe", "ordre", "famille", "sous_famille"]
LOGGER = structlog.get_logger()


def format_taxref():
    fn = DATADIR / "TAXREF_v18_2025" / "TAXREFv18.txt"
    taxref = (
        pl.read_csv(fn, separator="\t")
        .rename(str.lower)
        .with_columns(
            col("lb_nom").str.to_lowercase(),
            (
                col("sous_famille").is_not_null()
                + col("famille").is_not_null() * 10
                + col("ordre").is_not_null() * 100
                + col("classe").is_not_null() * 1000
            ).alias("priority"),
        )
        .select(
            [
                col("cd_nom").alias("species_id"),
                col("lb_nom").alias("species_name"),
                "priority",
            ]
            + TAXREF_HIERARCHY
        )
    )
    _check_duplicates(taxref)
    taxref = (
        taxref.sort(["species_name", "priority"], descending=[False, True])
        .unique("species_name")
        .drop("priority")
    )
    taxref.write_parquet(DATADIR / "taxref.parquet")


def _check_duplicates(frame: pl.DataFrame):
    frame = frame.sort("species_name").filter(col("species_name").is_duplicated())
    if frame.is_empty():
        return
    frame.write_csv(DATADIR / "taxref_duplicate_species.csv")
    LOGGER.warning(
        "taxref_duplicate_species",
        n_species=len(frame),
        n_names=frame["species_name"].n_unique(),
    )
